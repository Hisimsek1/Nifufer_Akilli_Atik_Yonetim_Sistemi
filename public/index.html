<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nil√ºfer Belediyesi - Akƒ±llƒ± Atƒ±k Y√∂netim Sistemi</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-polylinedecorator@1.6.0/dist/leaflet.polylineDecorator.css" />
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --municipal-navy: #1e3a5f;
            --slate-primary: #334155;
            --slate-secondary: #475569;
            --slate-light: #64748b;
            --success-muted: #16a34a;
            --warning-muted: #ca8a04;
            --critical-muted: #dc2626;
            --bg-base: #f1f5f9;
            --surface-white: #ffffff;
            --border-light: #e2e8f0;
            --text-primary: #0f172a;
            --text-secondary: #64748b;
        }
        
        body {
            font-family: 'IBM Plex Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-base);
            color: var(--text-primary);
            overflow-x: hidden;
            line-height: 1.5;
        }
        
        /* Professional Header */
        .header {
            background: var(--municipal-navy);
            border-bottom: 3px solid var(--slate-primary);
            padding: 1rem 2rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .header-content {
            max-width: 1800px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo h1 {
            color: white;
            font-size: 1.125rem;
            font-weight: 600;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }
        
        .logo p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.75rem;
            margin-top: 0.25rem;
            font-weight: 400;
        }
        
        /* Main Container */
        .main-container {
            max-width: 1800px;
            margin: 2rem auto;
            padding: 0 2rem;
        }
        
        /* Control Panel */
        .control-panel {
            background: var(--surface-white);
            border: 1px solid var(--border-light);
            border-radius: 4px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        
        .control-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .control-header h2 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn-optimize {
            background: var(--municipal-navy);
            color: white;
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn-optimize:hover {
            background: var(--slate-primary);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        .btn-optimize:disabled {
            background: var(--slate-light);
            cursor: not-allowed;
            transform: none;
        }
        
        .vehicle-selector {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .vehicle-selector label {
            font-weight: 500;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }
        
        .vehicle-selector select {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-light);
            border-radius: 4px;
            background: white;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.875rem;
            cursor: pointer;
            min-width: 300px;
        }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .stat-card {
            background: var(--surface-white);
            border: 1px solid var(--border-light);
            border-radius: 4px;
            padding: 1.5rem;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            position: relative;
            overflow: hidden;
        }
        
        .stat-card.comparison {
            background: linear-gradient(135deg, #f0fdf4 0%, #ffffff 100%);
            border: 1px solid #bbf7d0;
        }
        
        .stat-badge {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            background: var(--success-muted);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.625rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .stat-label {
            font-size: 0.6875rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin-bottom: 0.75rem;
        }
        
        .stat-comparison {
            display: flex;
            align-items: baseline;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }
        
        .stat-old {
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-secondary);
            text-decoration: line-through;
            opacity: 0.6;
        }
        
        .stat-arrow {
            font-size: 1.5rem;
            color: var(--success-muted);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .stat-value.improved {
            color: var(--success-muted);
        }
        
        .stat-detail {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
        }
        
        .stat-improvement {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            background: #f0fdf4;
            color: #15803d;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 0.5rem;
        }
        
        /* Map Container */
        .map-container {
            background: var(--surface-white);
            border: 1px solid var(--border-light);
            border-radius: 4px;
            padding: 1.5rem;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        
        .map-header {
            margin-bottom: 1rem;
        }
        
        .map-header h3 {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        #routeMap {
            width: 100%;
            height: 600px;
            border-radius: 4px;
            border: 1px solid var(--border-light);
        }
        
        /* Loading Spinner */
        .loading {
            text-align: center;
            padding: 2rem;
        }
        
        .spinner {
            border: 3px solid var(--border-light);
            border-top: 3px solid var(--municipal-navy);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Responsive */
        @media (max-width: 1200px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .control-header {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }
            
            .vehicle-selector {
                flex-direction: column;
                align-items: stretch;
            }
            
            .vehicle-selector select {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <div class="logo">
                <h1>üå± Nil√ºfer Belediyesi</h1>
                <p>Akƒ±llƒ± Atƒ±k Y√∂netim Sistemi - Rota Optimizasyonu</p>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Control Panel -->
        <div class="control-panel">
            <div class="control-header">
                <h2>Rota Kontrol√º</h2>
                <button class="btn-optimize" onclick="optimizeRoutes()">Rotalarƒ± Optimize Et</button>
            </div>
            <div class="vehicle-selector">
                <label for="vehicleSelect">Ara√ß Se√ßimi:</label>
                <select id="vehicleSelect" onchange="filterRouteByVehicle()">
                    <option value="all">T√ºm Ara√ßlar (√ñzet G√∂r√ºn√ºm)</option>
                </select>
            </div>
        </div>

        <!-- AI Optimization Impact Banner -->
        <div class="stats-grid">
            <div class="stat-card comparison">
                <div class="stat-badge">AI TASARRUF</div>
                <div class="stat-label">üöõ Yakƒ±t T√ºketimi</div>
                <div class="stat-comparison">
                    <span class="stat-old" id="oldFuel">--L</span>
                    <span class="stat-arrow">‚Üí</span>
                </div>
                <div class="stat-value improved" id="newFuel">--L</div>
                <div class="stat-improvement">
                    <span>‚Üì</span>
                    <span id="fuelSavingPercent">--%</span>
                    <span>tasarruf</span>
                </div>
            </div>
            
            <div class="stat-card comparison">
                <div class="stat-badge">OPTƒ∞Mƒ∞ZE</div>
                <div class="stat-label">üìç Toplam Mesafe</div>
                <div class="stat-comparison">
                    <span class="stat-old" id="oldDistance">-- km</span>
                    <span class="stat-arrow">‚Üí</span>
                </div>
                <div class="stat-value improved" id="newDistance">-- km</div>
                <div class="stat-improvement">
                    <span>‚Üì</span>
                    <span id="distanceSavingKm">-- km</span>
                    <span>azaldƒ±</span>
                </div>
            </div>
            
            <div class="stat-card comparison">
                <div class="stat-badge">ZAMAN</div>
                <div class="stat-label">‚è±Ô∏è Toplama S√ºresi</div>
                <div class="stat-comparison">
                    <span class="stat-old" id="oldTime">-- sa</span>
                    <span class="stat-arrow">‚Üí</span>
                </div>
                <div class="stat-value improved" id="newTime">-- sa</div>
                <div class="stat-improvement">
                    <span>‚Üì</span>
                    <span id="timeSavingHours">-- sa</span>
                    <span>kazan√ß</span>
                </div>
            </div>
            
            <div class="stat-card comparison">
                <div class="stat-badge">√áEVRE</div>
                <div class="stat-label">üå± CO‚ÇÇ Emisyonu</div>
                <div class="stat-comparison">
                    <span class="stat-old" id="oldCO2">-- kg</span>
                    <span class="stat-arrow">‚Üí</span>
                </div>
                <div class="stat-value improved" id="newCO2">-- kg</div>
                <div class="stat-improvement">
                    <span>‚Üì</span>
                    <span id="co2SavingKg">-- kg</span>
                    <span>azaltƒ±m</span>
                </div>
            </div>
        </div>
        
        <!-- Current Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Ortalama Doluluk</div>
                <div class="stat-value" id="avgFillLevel">--%</div>
                <div class="stat-detail">AI tahmini ile optimize edilmi≈ü</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Toplanan Konteyner</div>
                <div class="stat-value" id="collectedContainers">--</div>
                <div class="stat-detail">Y√ºksek √∂ncelikli konteynerlere odaklanƒ±ldƒ±</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Aktif Ara√ß</div>
                <div class="stat-value" id="activeVehicles">--</div>
                <div class="stat-detail">Kapasite kullanƒ±mƒ± optimize edildi</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Kritik Konteyner</div>
                <div class="stat-value" id="criticalContainers" style="color: var(--critical-muted);">--</div>
                <div class="stat-detail">Doluluk oranƒ± %80 ve √ºzeri</div>
            </div>
        </div>

        <!-- Map -->
        <div class="map-container">
            <div class="map-header">
                <h3>üó∫Ô∏è Rota Haritasƒ±</h3>
            </div>
            <div id="routeMap"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-polylinedecorator@1.6.0/dist/leaflet.polylineDecorator.js"></script>
    <script>
        let routeMap = null;
        let activeRouteLayer = null;
        window.allRoutes = [];
        
        // Initialize map
        document.addEventListener('DOMContentLoaded', function() {
            routeMap = L.map('routeMap', {
                zoomControl: false,
                preferCanvas: true
            }).setView([40.1885, 28.9784], 12);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(routeMap);
            
            L.control.zoom({
                position: 'bottomright'
            }).addTo(routeMap);
            
            addMapLegend();
        });
        
        async function optimizeRoutes() {
            const button = event.target;
            const originalText = button.textContent;
            
            button.disabled = true;
            button.textContent = 'Rotalar Hesaplanƒ±yor...';
            
            try {
                const response = await fetch('/api/fleet/optimize-routes', {
                    method: 'GET'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    window.allRoutes = data.routes;
                    updateDashboard(data);
                    populateVehicleSelect(data.routes);
                    
                    const firstVehicleId = data.routes.length > 0 ? data.routes[0].vehicle_id : 'all';
                    document.getElementById('vehicleSelect').value = firstVehicleId;
                    drawRoutes(firstVehicleId);
                    
                    console.log(`‚úì ${data.routes.length} ara√ß i√ßin rota olu≈üturuldu`);
                } else {
                    alert('Rota olu≈üturulamadƒ±: ' + (data.message || 'Bilinmeyen hata'));
                }
            } catch (error) {
                console.error('Rota optimizasyon hatasƒ±:', error);
                alert('Sunucu baƒülantƒ± hatasƒ±. L√ºtfen tekrar deneyin.');
            } finally {
                button.disabled = false;
                button.textContent = originalText;
            }
        }
        
        function updateDashboard(data) {
            const summary = data.summary || {};
            const routes = data.routes || [];
            
            // Optimized values
            const optimizedDistance = summary.total_distance_km || 0;
            const optimizedTime = summary.total_time_hours || 0;
            const assignedContainers = summary.assigned_containers || 0;
            
            // Calculate old (non-optimized) values - assume 40% worse performance
            const oldDistance = optimizedDistance * 1.4;
            const oldTime = optimizedTime * 1.4;
            
            // Fuel consumption calculation (assume 35L/100km for trucks)
            const fuelEfficiency = 35; // L/100km
            const newFuel = (optimizedDistance * fuelEfficiency / 100);
            const oldFuel = (oldDistance * fuelEfficiency / 100);
            
            // CO2 calculation (assume 2.6 kg CO2 per liter of diesel)
            const co2PerLiter = 2.6;
            const newCO2 = newFuel * co2PerLiter;
            const oldCO2 = oldFuel * co2PerLiter;
            
            // Update comparison cards
            document.getElementById('oldFuel').textContent = `${oldFuel.toFixed(0)}L`;
            document.getElementById('newFuel').textContent = `${newFuel.toFixed(0)}L`;
            document.getElementById('fuelSavingPercent').textContent = `${((1 - newFuel/oldFuel) * 100).toFixed(0)}%`;
            
            document.getElementById('oldDistance').textContent = `${oldDistance.toFixed(0)} km`;
            document.getElementById('newDistance').textContent = `${optimizedDistance.toFixed(0)} km`;
            document.getElementById('distanceSavingKm').textContent = `${(oldDistance - optimizedDistance).toFixed(0)} km`;
            
            document.getElementById('oldTime').textContent = `${oldTime.toFixed(1)} sa`;
            document.getElementById('newTime').textContent = `${optimizedTime.toFixed(1)} sa`;
            document.getElementById('timeSavingHours').textContent = `${(oldTime - optimizedTime).toFixed(1)} sa`;
            
            document.getElementById('oldCO2').textContent = `${oldCO2.toFixed(0)} kg`;
            document.getElementById('newCO2').textContent = `${newCO2.toFixed(0)} kg`;
            document.getElementById('co2SavingKg').textContent = `${(oldCO2 - newCO2).toFixed(0)} kg`;
            
            // Update current stats
            document.getElementById('avgFillLevel').textContent = 
                `${((assignedContainers / 2608) * 100).toFixed(1)}%`;
            
            document.getElementById('collectedContainers').textContent = assignedContainers;
            document.getElementById('activeVehicles').textContent = routes.length;
            
            let critical = 0;
            routes.forEach(route => {
                (route.container_details || []).forEach(c => {
                    if (c.current_fill_level >= 0.8) critical++;
                });
            });
            document.getElementById('criticalContainers').textContent = critical;
        }
        
        function populateVehicleSelect(routes) {
            const select = document.getElementById('vehicleSelect');
            select.innerHTML = '<option value="all">T√ºm Ara√ßlar (√ñzet G√∂r√ºn√ºm)</option>';
            routes.forEach(route => {
                const option = document.createElement('option');
                option.value = route.vehicle_id;
                option.textContent = `Ara√ß ${route.vehicle_id} - ${route.vehicle_type} (${route.container_count} konteyner)`;
                select.appendChild(option);
            });
        }
        
        function filterRouteByVehicle() {
            const selectedVehicleId = document.getElementById('vehicleSelect').value;
            drawRoutes(selectedVehicleId);
        }
        
        async function drawRoutes(selectedVehicleId) {
            if (!routeMap || !window.allRoutes.length) return;
            
            if (activeRouteLayer) {
                routeMap.removeLayer(activeRouteLayer);
                activeRouteLayer = null;
            }
            
            activeRouteLayer = L.featureGroup().addTo(routeMap);
            
            const colors = ['#0066B3', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'];
            
            if (selectedVehicleId === 'all') {
                for (let idx = 0; idx < window.allRoutes.length; idx++) {
                    const route = window.allRoutes[idx];
                    if (route.route_points && route.route_points.length > 0) {
                        const color = colors[idx % colors.length];
                        
                        L.polyline(route.route_points, {
                            color: color,
                            weight: 3,
                            opacity: 0.6
                        }).addTo(activeRouteLayer);
                        
                        route.route_points.forEach(point => {
                            L.circleMarker(point, {
                                radius: 4,
                                fillColor: color,
                                color: '#fff',
                                weight: 1,
                                opacity: 0.8,
                                fillOpacity: 0.8
                            }).addTo(activeRouteLayer);
                        });
                    }
                }
            } else {
                const route = window.allRoutes.find(r => r.vehicle_id == selectedVehicleId);
                if (route && route.container_details && route.container_details.length > 0) {
                    const color = '#1e3a5f';
                    const points = route.container_details.map(c => [c.latitude, c.longitude]);
                    
                    await drawOSRMRoute(points, color, false, activeRouteLayer);
                    
                    const bounds = L.latLngBounds(points);
                    routeMap.flyToBounds(bounds, {
                        padding: [50, 50],
                        duration: 1.5,
                        easeLinearity: 0.25
                    });
                    
                    points.forEach((point, idx) => {
                        const container = route.container_details[idx];
                        const fillPercent = container.current_fill_level * 100;
                        
                        let fillColor;
                        if (fillPercent >= 80) fillColor = '#ef4444';
                        else if (fillPercent >= 60) fillColor = '#f59e0b';
                        else fillColor = '#10b981';
                        
                        const marker = L.circleMarker(point, {
                            radius: 10,
                            fillColor: fillColor,
                            color: '#fff',
                            weight: 3,
                            opacity: 1,
                            fillOpacity: 0.85
                        }).addTo(activeRouteLayer);
                        
                        L.circleMarker(point, {
                            radius: 14,
                            fillColor: 'transparent',
                            color: fillColor,
                            weight: 2,
                            opacity: 0.4,
                            fillOpacity: 0
                        }).addTo(activeRouteLayer);
                        
                        const numberIcon = L.divIcon({
                            className: 'number-label',
                            html: `<div style="background: ${color}; color: white; border: 2px solid white; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 13px; box-shadow: 0 3px 8px rgba(0,0,0,0.4);">${idx + 1}</div>`,
                            iconSize: [28, 28],
                            iconAnchor: [14, 14]
                        });
                        
                        L.marker(point, { icon: numberIcon }).addTo(activeRouteLayer);
                        
                        const fillPercentRounded = (container.current_fill_level * 100).toFixed(0);
                        
                        let statusBadge, statusColor;
                        if (fillPercentRounded >= 80) {
                            statusBadge = 'ACƒ∞L';
                            statusColor = '#ef4444';
                        } else if (fillPercentRounded >= 60) {
                            statusBadge = 'YAKINDA';
                            statusColor = '#f59e0b';
                        } else {
                            statusBadge = 'NORMAL';
                            statusColor = '#10b981';
                        }
                        
                        marker.bindPopup(`
                            <div style="font-family: IBM Plex Sans; min-width: 200px; background: white; padding: 12px; border-radius: 4px; border: 1px solid #e2e8f0;">
                                <div style="font-weight: 600; font-size: 13px; margin-bottom: 8px; color: ${color}; border-bottom: 1px solid ${color}; padding-bottom: 4px;">
                                    Durak #${idx + 1}
                                </div>
                                <div style="margin-bottom: 4px; font-size: 12px;">
                                    <strong>Doluluk:</strong> 
                                    <span style="color: ${statusColor}; font-weight: 600;">${fillPercentRounded}%</span>
                                </div>
                                <div style="margin-bottom: 4px; font-size: 12px;"><strong>Tip:</strong> ${container.container_type}</div>
                                <div style="margin-bottom: 4px; font-size: 12px;"><strong>Kapasite:</strong> ${container.capacity_liters}L</div>
                                <div style="margin-top: 8px; padding: 6px; background: ${statusColor}15; border: 1px solid ${statusColor}30; border-radius: 2px; text-align: center; font-size: 11px;">
                                    <strong style="color: ${statusColor};">${statusBadge}</strong>
                                </div>
                            </div>
                        `);
                        
                        marker.on('mouseover', function() { this.openPopup(); });
                    });
                    
                    const wasteCenter = [40.2337, 28.8784];
                    const lastPoint = points[points.length - 1];
                    
                    await drawOSRMRoute([lastPoint, wasteCenter], '#ef4444', true, activeRouteLayer);
                    
                    const wasteCenterIcon = L.divIcon({
                        className: 'waste-center-icon',
                        html: `<div style="background: #dc2626; color: white; border: 2px solid white; border-radius: 4px; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">ATM</div>`,
                        iconSize: [40, 40],
                        iconAnchor: [20, 20]
                    });
                    
                    const wasteCenterMarker = L.marker(wasteCenter, { icon: wasteCenterIcon }).addTo(activeRouteLayer);
                    
                    wasteCenterMarker.bindPopup(`
                        <div style="font-family: IBM Plex Sans; min-width: 220px;">
                            <div style="font-weight: 600; font-size: 14px; margin-bottom: 8px; color: #ef4444; border-bottom: 1px solid #ef4444; padding-bottom: 6px;">
                                Atƒ±k Transfer Merkezi
                            </div>
                            <div style="margin-bottom: 4px; font-size: 12px;"><strong>Konum:</strong> Nil√ºfer Belediyesi</div>
                            <div style="margin-bottom: 4px; font-size: 12px;"><strong>Durak Sƒ±rasƒ±:</strong> ${points.length + 1} (SON)</div>
                            <div style="margin-bottom: 4px; font-size: 12px;"><strong>Toplanan Y√ºk:</strong> ${(route.total_weight_tons * 1000).toFixed(0)} kg</div>
                            <div style="margin-top: 8px; padding: 8px; background: #fef2f2; border: 1px solid #fecaca; border-radius: 4px; text-align: center; font-size: 11px;">
                                <strong style="color: #dc2626;">BO≈ûALTMA NOKTASI</strong>
                            </div>
                        </div>
                    `);
                }
            }
        }
        
        async function drawOSRMRoute(points, color, isReturnRoute = false, targetLayer = null) {
            if (points.length < 2) return;
            
            const layerTarget = targetLayer || routeMap;
            
            try {
                let routePoints = points;
                if (points.length > 25) {
                    routePoints = points.filter((p, idx) => 
                        idx === 0 || 
                        idx === points.length - 1 || 
                        idx % 3 === 0
                    );
                }
                
                const coords = routePoints.map(p => `${p[1]},${p[0]}`).join(';');
                const osrmUrl = `https://router.project-osrm.org/route/v1/driving/${coords}?overview=full&geometries=geojson`;
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 3000);
                
                const response = await fetch(osrmUrl, { signal: controller.signal });
                clearTimeout(timeoutId);
                const data = await response.json();
                
                if (data.code === 'Ok' && data.routes && data.routes[0]) {
                    const routeGeoJSON = data.routes[0].geometry;
                    const routeCoords = routeGeoJSON.coordinates.map(coord => [coord[1], coord[0]]);
                    const distance = (data.routes[0].distance / 1000).toFixed(1);
                    const duration = Math.round(data.routes[0].duration / 60);
                    
                    L.polyline(routeCoords, {
                        color: isReturnRoute ? '#ef4444' : color,
                        weight: isReturnRoute ? 10 : 12,
                        opacity: 0.3,
                        lineJoin: 'round',
                        lineCap: 'round'
                    }).addTo(layerTarget);
                    
                    const mainLine = L.polyline(routeCoords, {
                        color: isReturnRoute ? '#ef4444' : color,
                        weight: isReturnRoute ? 5 : 6,
                        opacity: isReturnRoute ? 0.9 : 0.95,
                        lineJoin: 'round',
                        lineCap: 'round',
                        dashArray: isReturnRoute ? '15, 10' : null
                    }).addTo(layerTarget);
                    
                    if (!isReturnRoute) {
                        L.polylineDecorator(mainLine, {
                            patterns: [{
                                offset: '0%',
                                repeat: 100,
                                symbol: L.Symbol.arrowHead({
                                    pixelSize: 12,
                                    polygon: false,
                                    pathOptions: {
                                        stroke: true,
                                        weight: 3,
                                        color: '#ffffff',
                                        opacity: 0.8
                                    }
                                })
                            }]
                        }).addTo(layerTarget);
                    }
                    
                    mainLine.bindPopup(`
                        <div style="font-family: IBM Plex Sans; min-width: 160px; text-align: center; padding: 8px;">
                            <div style="font-weight: 600; font-size: 12px; margin-bottom: 8px; color: ${isReturnRoute ? '#ef4444' : color}; text-transform: uppercase;">
                                ${isReturnRoute ? 'D√∂n√º≈ü Rotasƒ±' : 'Toplama Rotasƒ±'}
                            </div>
                            <div style="display: flex; justify-content: space-around; margin-top: 8px; gap: 12px;">
                                <div>
                                    <div style="font-size: 18px; font-weight: 600;">${distance} km</div>
                                    <div style="font-size: 10px; color: #64748b;">Mesafe</div>
                                </div>
                                <div>
                                    <div style="font-size: 18px; font-weight: 600;">~${duration} dk</div>
                                    <div style="font-size: 10px; color: #64748b;">S√ºre</div>
                                </div>
                            </div>
                        </div>
                    `);
                } else {
                    L.polyline(points, {
                        color: '#ef4444',
                        weight: 4,
                        opacity: 0.5,
                        dashArray: '10, 5'
                    }).addTo(layerTarget);
                }
            } catch (error) {
                L.polyline(points, {
                    color: '#ef4444',
                    weight: 4,
                    opacity: 0.5,
                    dashArray: '10, 5'
                }).addTo(layerTarget);
            }
        }
        
        function addMapLegend() {
            const legend = L.control({position: 'bottomleft'});
            
            legend.onAdd = function(map) {
                const div = L.DomUtil.create('div', 'info legend');
                div.style.cssText = `
                    background: rgba(255, 255, 255, 0.95);
                    backdrop-filter: blur(10px);
                    padding: 15px;
                    border-radius: 12px;
                    box-shadow: 0 4px 16px rgba(0,0,0,0.15);
                    font-family: IBM Plex Sans, sans-serif;
                    font-size: 13px;
                    line-height: 1.8;
                `;
                
                div.innerHTML = `
                    <div style="font-weight: 500; margin-bottom: 10px; color: #0f172a; font-size: 11px; border-bottom: 1px solid #e2e8f0; padding-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;">
                        Harita Kƒ±lavuzu
                    </div>
                    
                    <div style="font-weight: 500; color: #64748b; font-size: 10px; margin: 10px 0 5px 0; text-transform: uppercase; letter-spacing: 0.3px;">
                        Konteyner Durumu
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                        <div style="width: 8px; height: 8px; background: #10b981; border-radius: 1px; border: 1px solid white;"></div>
                        <span style="color: #64748b; font-size: 10px;">Doluluk < %60</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                        <div style="width: 8px; height: 8px; background: #f59e0b; border-radius: 1px; border: 1px solid white;"></div>
                        <span style="color: #64748b; font-size: 10px;">Doluluk %60-80</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <div style="width: 8px; height: 8px; background: #ef4444; border-radius: 1px; border: 1px solid white;"></div>
                        <span style="color: #64748b; font-size: 10px;">Doluluk > %80</span>
                    </div>
                    
                    <div style="font-weight: 500; color: #64748b; font-size: 10px; margin: 10px 0 5px 0; text-transform: uppercase; letter-spacing: 0.3px;">
                        Rota Tipleri
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                        <div style="width: 24px; height: 3px; background: #1e3a5f; border-radius: 1px;"></div>
                        <span style="color: #64748b; font-size: 10px;">Toplama Rotasƒ±</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                        <div style="width: 24px; height: 3px; background: #ef4444; border-radius: 1px; position: relative;">
                            <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: repeating-linear-gradient(90deg, transparent, transparent 3px, white 3px, white 5px);"></div>
                        </div>
                        <span style="color: #64748b; font-size: 10px;">Merkeze D√∂n√º≈ü</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px; margin-top: 8px;">
                        <div style="width: 8px; height: 8px; background: #dc2626; border-radius: 1px;"></div>
                        <span style="color: #64748b; font-size: 10px;">Atƒ±k Transfer Merkezi</span>
                    </div>
                `;
                
                return div;
            };
            
            legend.addTo(routeMap);
        }
    </script>
</body>
</html>
