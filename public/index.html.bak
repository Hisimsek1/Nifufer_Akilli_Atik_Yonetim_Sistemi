<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nil√ºfer Akƒ±llƒ± Atƒ±k Y√∂netim</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Roboto', Arial, sans-serif;
            background: #F5F5F5;
            color: #333;
        }
        .header {
            background: linear-gradient(135deg, #0066B3 0%, #004d87 100%);
            color: white;
            padding: 25px 0;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .header h1 {
            font-size: 32px;
            font-weight: 700;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* User Bar */
        .user-bar {
            background: white;
            padding: 15px 30px;
            margin-bottom: 20px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .user-name {
            font-weight: 600;
            font-size: 18px;
            color: #0066B3;
        }
        .user-stats {
            display: flex;
            gap: 30px;
        }
        .stat-item {
            text-align: center;
        }
        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: #00A651;
        }
        .stat-label {
            font-size: 12px;
            color: #666;
        }
        .btn-logout {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
        }
        
        /* Auth */
        .auth-panel {
            max-width: 500px;
            margin: 60px auto;
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .auth-panel h2 {
            color: #0066B3;
            margin-bottom: 30px;
            text-align: center;
            font-size: 28px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 14px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        .form-group input:focus {
            outline: none;
            border-color: #0066B3;
        }
        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-primary {
            background: #0066B3;
            color: white;
        }
        .btn-success {
            background: #00A651;
            color: white;
        }
        .switch-form {
            text-align: center;
            margin-top: 20px;
            color: #666;
        }
        .switch-form a {
            color: #0066B3;
            font-weight: 600;
            text-decoration: none;
        }
        
        /* Main */
        .section {
            background: white;
            padding: 30px;
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .section-title {
            color: #0066B3;
            font-size: 24px;
            margin-bottom: 20px;
            font-weight: 600;
        }
        
        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: linear-gradient(135deg, #0066B3 0%, #004d87 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-card h3 {
            font-size: 42px;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        /* Tabs */
        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .tab-btn {
            padding: 12px 25px;
            background: #f0f0f0;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        .tab-btn.active {
            background: #0066B3;
            color: white;
        }
        
        /* Map */
        #map {
            height: 400px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        /* Leaderboard */
        .leaderboard-item {
            background: white;
            border: 2px solid #f0f0f0;
            padding: 15px 20px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .leaderboard-item.top3 {
            background: linear-gradient(135deg, #fff8e1 0%, #fff3cd 100%);
            border-color: #ffc107;
        }
        .rank {
            font-size: 28px;
            font-weight: 700;
            color: #0066B3;
            width: 50px;
        }
        .trust-score {
            font-size: 24px;
            font-weight: 700;
            color: #00A651;
        }
        
        /* Containers */
        .container-item {
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #dc3545;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .alert {
            padding: 15px 20px;
            margin-bottom: 20px;
            border-radius: 6px;
            font-weight: 500;
        }
        .alert-error {
            background: #f8d7da;
            color: #721c24;
        }
        .alert-success {
            background: #d4edda;
            color: #155724;
        }
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üóëÔ∏è Nil√ºfer Akƒ±llƒ± Atƒ±k Y√∂netim Sistemi</h1>
        <p>Yapay Zeka Destekli Platformu</p>
    </div>

    <div class="container">
        <!-- AUTH -->
        <div id="authPanel" class="auth-panel">
            <div id="loginForm">
                <h2>Giri≈ü Yap</h2>
                <div id="loginError" class="alert alert-error hidden"></div>
                <form onsubmit="login(event)">
                    <div class="form-group">
                        <label>TC Kimlik No</label>
                        <input type="text" id="loginTC" placeholder="12345678901" maxlength="11" required>
                    </div>
                    <div class="form-group">
                        <label>≈ûifre</label>
                        <input type="password" id="loginPassword" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Giri≈ü</button>
                </form>
                <div class="switch-form">
                    <a href="#" onclick="showRegister(); return false;">Kayƒ±t Ol</a>
                </div>
            </div>

            <div id="registerForm" class="hidden">
                <h2>Kayƒ±t Ol</h2>
                <div id="registerError" class="alert alert-error hidden"></div>
                <form onsubmit="register(event)">
                    <div class="form-group">
                        <label>Ad Soyad</label>
                        <input type="text" id="registerName" required>
                    </div>
                    <div class="form-group">
                        <label>TC Kimlik No</label>
                        <input type="text" id="registerTC" maxlength="11" required>
                    </div>
                    <div class="form-group">
                        <label>Telefon</label>
                        <input type="tel" id="registerPhone" required>
                    </div>
                    <div class="form-group">
                        <label>≈ûifre</label>
                        <input type="password" id="registerPassword" minlength="6" required>
                    </div>
                    <button type="submit" class="btn btn-success">Kayƒ±t</button>
                </form>
                <div class="switch-form">
                    <a href="#" onclick="showLogin(); return false;">Giri≈ü Yap</a>
                </div>
            </div>
        </div>

        <!-- USER BAR -->
        <div id="userBar" class="user-bar hidden">
            <div>
                <div class="user-name" id="userName"></div>
            </div>
            <div class="user-stats">
                <div class="stat-item">
                    <div class="stat-value" id="userTrustScore">0.00</div>
                    <div class="stat-label">G√ºven Puanƒ±</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="userReports">0</div>
                    <div class="stat-label">Bildirimler</div>
                </div>
            </div>
            <button onclick="logout()" class="btn-logout">√áƒ±kƒ±≈ü</button>
        </div>

        <!-- MAIN -->
        <div id="mainContent" class="hidden">
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="totalContainers">0</h3>
                    <p>Toplam Konteyner</p>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">
                    <h3 id="fullContainers">0</h3>
                    <p>Dolu Konteyner</p>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #00A651 0%, #008040 100%);">
                    <h3 id="todayCollections">0</h3>
                    <p>Bug√ºn Toplanan</p>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);">
                    <h3 id="fillRate">0%</h3>
                    <p>Doluluk Oranƒ±</p>
                </div>
            </div>

            <div class="tab-buttons">
                <button class="tab-btn active" onclick="showTab('report')">üìù Bildirim</button>
                <button class="tab-btn" onclick="showTab('map')">üó∫Ô∏è Harita</button>
                <button class="tab-btn" onclick="showTab('containers')">üóëÔ∏è Konteynerler</button>
                <button class="tab-btn" onclick="showTab('leaderboard')">üèÜ Liderlik</button>
            </div>

            <div id="tabReport" class="section">
                <h2 class="section-title">Doluluk Bildirimi</h2>
                <div class="alert alert-info">
                    <strong>G√ºven Puanƒ±nƒ±z:</strong> <span id="reportTrustScore">0.00</span>
                    <span id="photoMsg"></span>
                </div>
                <form onsubmit="submitReport(event)">
                    <div class="form-group">
                        <label>Konteyner ID</label>
                        <input type="number" id="reportContainerId" required>
                    </div>
                    <div class="form-group">
                        <label>Doluluk (%): <span id="fillValue">50%</span></label>
                        <input type="range" id="reportFillLevel" min="0" max="100" value="50" oninput="document.getElementById('fillValue').textContent = this.value + '%'">
                    </div>
                    <div class="form-group">
                        <label>Fotoƒüraf <span id="photoRequired" style="color: #dc3545;"></span></label>
                        <input type="file" id="reportPhoto" accept="image/*">
                    </div>
                    <div class="form-group">
                        <label>Not (Opsiyonel)</label>
                        <textarea id="reportNotes" rows="3"></textarea>
                    </div>
                    <button type="submit" class="btn btn-success">G√∂nder</button>
                </form>
            </div>

            <div id="tabMap" class="section hidden">
                <h2 class="section-title">Konteyner Haritasƒ±</h2>
                <div id="map"></div>
            </div>

            <div id="tabContainers" class="section hidden">
                <h2 class="section-title">T√ºm Konteynerler</h2>
                <div style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 14px;">
                    <span style="margin-right: 20px;">üî¥ DOLU (%75+)</span>
                    <span style="margin-right: 20px;">üü° ORTA (%50-74)</span>
                    <span>üü¢ BO≈û (%0-49)</span>
                </div>
                <div id="containerList"></div>
            </div>

            <div id="tabLeaderboard" class="section hidden">
                <h2 class="section-title">Liderlik Tablosu</h2>
                <div id="leaderboardList"></div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let currentUser = null;
        let map = null;

        function showRegister() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
        }

        function showLogin() {
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('loginForm').classList.remove('hidden');
        }

        async function register(event) {
            event.preventDefault();
            const name = document.getElementById('registerName').value;
            const tc = document.getElementById('registerTC').value;
            const phone = document.getElementById('registerPhone').value;
            const password = document.getElementById('registerPassword').value;
            
            if (tc.length !== 11) {
                showError('registerError', 'TC 11 haneli olmalƒ±!');
                return;
            }
            
            try {
                const res = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, tc_number: tc, phone, password })
                });
                const data = await res.json();
                if (data.success) {
                    showError('registerError', 'Kayƒ±t ba≈üarƒ±lƒ±! Giri≈ü yapƒ±n.', 'success');
                    setTimeout(() => {
                        showLogin();
                        document.querySelector('#registerForm form').reset();
                    }, 2000);
                } else {
                    showError('registerError', data.error);
                }
            } catch (e) {
                showError('registerError', 'Baƒülantƒ± hatasƒ±!');
            }
        }

        async function login(event) {
            event.preventDefault();
            const tc = document.getElementById('loginTC').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                const res = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tc_number: tc, password })
                });
                const data = await res.json();
                if (data.success) {
                    currentUser = data.user;
                    localStorage.setItem('user', JSON.stringify(currentUser));
                    showUserPanel();
                } else {
                    showError('loginError', data.error);
                }
            } catch (e) {
                showError('loginError', 'Baƒülantƒ± hatasƒ±!');
            }
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('user');
            document.getElementById('authPanel').classList.remove('hidden');
            document.getElementById('userBar').classList.add('hidden');
            document.getElementById('mainContent').classList.add('hidden');
            showLogin();
        }

        function showUserPanel() {
            document.getElementById('authPanel').classList.add('hidden');
            document.getElementById('userBar').classList.remove('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
            
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userTrustScore').textContent = currentUser.trust_score.toFixed(2);
            document.getElementById('userReports').textContent = currentUser.total_reports || 0;
            document.getElementById('reportTrustScore').textContent = currentUser.trust_score.toFixed(2);
            
            if (currentUser.trust_score < 0.7) {
                document.getElementById('photoRequired').textContent = '(ZORUNLU)';
                document.getElementById('reportPhoto').required = true;
                document.getElementById('photoMsg').textContent = ' - Fotoƒüraf zorunludur.';
            }
            
            loadDashboard();
            loadLeaderboard();
            initMap();
        }

        async function loadDashboard() {
            try {
                const res = await fetch('/api/dashboard/stats');
                const data = await res.json();
                document.getElementById('totalContainers').textContent = data.total_containers;
                document.getElementById('fullContainers').textContent = data.full_containers;
                document.getElementById('fillRate').textContent = (data.fill_rate * 100).toFixed(1) + '%';
                document.getElementById('todayCollections').textContent = data.today_collections;
            } catch (e) {}
        }

        async function loadLeaderboard() {
            try {
                const res = await fetch('/api/leaderboard');
                const data = await res.json();
                const list = document.getElementById('leaderboardList');
                list.innerHTML = data.leaderboard.map(u => `
                    <div class="leaderboard-item ${u.rank <= 3 ? 'top3' : ''}">
                        <div class="rank">${u.rank}</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600;">${u.name}</div>
                            <small style="color: #666;">${u.total_reports} bildirim</small>
                        </div>
                        <div class="trust-score">${u.trust_score.toFixed(2)}</div>
                    </div>
                `).join('');
            } catch (e) {}
        }

        async function loadContainers() {
            try {
                const res = await fetch('/api/containers/all');
                const data = await res.json();
                const list = document.getElementById('containerList');
                
                // Doluluk seviyesine g√∂re renk belirleme
                const getColor = (level) => {
                    if (level >= 0.75) return '#dc3545'; // Kƒ±rmƒ±zƒ± - Dolu
                    if (level >= 0.50) return '#ffc107'; // Sarƒ± - Orta
                    return '#28a745'; // Ye≈üil - Az dolu
                };
                
                const getStatus = (level) => {
                    if (level >= 0.75) return 'üî¥ DOLU';
                    if (level >= 0.50) return 'üü° ORTA';
                    return 'üü¢ BO≈û';
                };
                
                list.innerHTML = data.containers.map(c => `
                    <div class="container-item" style="border-left-color: ${getColor(c.fill_level)};">
                        <div>
                            <strong>Konteyner #${c.id}</strong>
                            <span style="margin-left: 10px; font-size: 12px; color: ${getColor(c.fill_level)}; font-weight: 600;">
                                ${getStatus(c.fill_level)}
                            </span><br>
                            <small>${c.neighborhood} - ${c.type} (${c.capacity}L)</small>
                        </div>
                        <div style="text-align: right;">
                            <strong style="color: ${getColor(c.fill_level)}; font-size: 20px;">
                                ${(c.fill_level * 100).toFixed(0)}%
                            </strong><br>
                            <button onclick="selectContainer(${c.id}, ${(c.fill_level * 100).toFixed(0)})" 
                                    style="background: #0066B3; color: white; border: none; padding: 5px 15px; 
                                           border-radius: 5px; cursor: pointer; margin-top: 5px; font-size: 12px;">
                                Bildir
                            </button>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                console.error('Konteyner y√ºkleme hatasƒ±:', e);
            }
        }
        
        function selectContainer(containerId, fillLevel) {
            // Bildirim sekmesine ge√ß ve formu doldur
            showTab('report');
            document.getElementById('reportContainerId').value = containerId;
            document.getElementById('reportFillLevel').value = fillLevel;
            document.getElementById('fillValue').textContent = fillLevel + '%';
            
            // Forma scroll
            document.getElementById('tabReport').scrollIntoView({ behavior: 'smooth' });
        }

        function initMap() {
            if (!map) {
                map = L.map('map').setView([40.2, 28.9], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(map);
                
                // Konteynerleri y√ºkle
                loadMapMarkers();
            }
        }
        
        let markerCluster = null;
        
        async function loadMapMarkers() {
            try {
                const res = await fetch('/api/containers/map');
                const data = await res.json();
                
                // Eski marker'larƒ± temizle
                if (markerCluster) {
                    map.removeLayer(markerCluster);
                }
                
                // Marker renk fonksiyonu
                const getMarkerColor = (level) => {
                    if (level >= 0.75) return 'red';
                    if (level >= 0.50) return 'orange';
                    return 'green';
                };
                
                const getMarkerIcon = (level) => {
                    const color = getMarkerColor(level);
                    return L.icon({
                        iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${color}.png`,
                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowSize: [41, 41]
                    });
                };
                
                // Marker'larƒ± olu≈ütur
                const markers = data.containers.map(c => {
                    const marker = L.marker([c.lat, c.lng], {
                        icon: getMarkerIcon(c.fill_level)
                    });
                    
                    // Popup i√ßeriƒüi
                    const status = c.fill_level >= 0.75 ? 'üî¥ DOLU' : 
                                   c.fill_level >= 0.50 ? 'üü° ORTA' : 'üü¢ BO≈û';
                    
                    const popupContent = `
                        <div style="min-width: 200px;">
                            <h3 style="margin: 0 0 10px 0; color: #0066B3;">Konteyner #${c.id}</h3>
                            <p style="margin: 5px 0;"><strong>Durum:</strong> ${status}</p>
                            <p style="margin: 5px 0;"><strong>Doluluk:</strong> ${(c.fill_level * 100).toFixed(0)}%</p>
                            <p style="margin: 5px 0;"><strong>Tip:</strong> ${c.type}</p>
                            <p style="margin: 5px 0;"><strong>Kapasite:</strong> ${c.capacity}L</p>
                            <p style="margin: 5px 0;"><strong>Mahalle:</strong> ${c.neighborhood}</p>
                            <button onclick="selectContainerFromMap(${c.id}, ${(c.fill_level * 100).toFixed(0)})"
                                    style="width: 100%; margin-top: 10px; padding: 8px; background: #0066B3; 
                                           color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">
                                üìù Bildirim Yap
                            </button>
                        </div>
                    `;
                    
                    marker.bindPopup(popupContent);
                    return marker;
                });
                
                // T√ºm marker'larƒ± haritaya ekle
                markers.forEach(m => m.addTo(map));
                
                // ƒ∞lk konteyner'a zoom
                if (data.containers.length > 0) {
                    const bounds = L.latLngBounds(data.containers.map(c => [c.lat, c.lng]));
                    map.fitBounds(bounds, { padding: [50, 50] });
                }
                
                console.log(`‚úì ${data.count} konteyner haritaya eklendi`);
                
            } catch (e) {
                console.error('Harita y√ºkleme hatasƒ±:', e);
            }
        }
        
        function selectContainerFromMap(containerId, fillLevel) {
            // Bildirim sekmesine ge√ß
            showTab('report');
            document.getElementById('reportContainerId').value = containerId;
            document.getElementById('reportFillLevel').value = fillLevel;
            document.getElementById('fillValue').textContent = fillLevel + '%';
            
            // Forma scroll
            setTimeout(() => {
                document.getElementById('tabReport').scrollIntoView({ behavior: 'smooth' });
            }, 100);
        }

        async function submitReport(event) {
            event.preventDefault();
            
            const containerId = document.getElementById('reportContainerId').value;
            const fillLevel = document.getElementById('reportFillLevel').value;
            const photo = document.getElementById('reportPhoto').files[0];
            const notes = document.getElementById('reportNotes').value;
            
            // Fotoƒüraf kontrol√º
            if (currentUser.trust_score < 0.7 && !photo) {
                alert('‚ö†Ô∏è G√ºven puanƒ±nƒ±z d√º≈ü√ºk olduƒüu i√ßin fotoƒüraf zorunludur!');
                return;
            }
            
            try {
                const res = await fetch('/api/reports/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: currentUser.id,
                        container_id: parseInt(containerId),
                        fill_level: parseInt(fillLevel),
                        has_photo: photo ? true : false,
                        notes: notes
                    })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    // Kullanƒ±cƒ± bilgilerini g√ºncelle
                    currentUser.trust_score = data.trust_score;
                    currentUser.total_reports = data.total_reports;
                    localStorage.setItem('user', JSON.stringify(currentUser));
                    
                    // Ekrandaki bilgileri g√ºncelle
                    document.getElementById('userTrustScore').textContent = data.trust_score.toFixed(2);
                    document.getElementById('userReports').textContent = data.total_reports;
                    document.getElementById('reportTrustScore').textContent = data.trust_score.toFixed(2);
                    
                    // Fotoƒüraf gereksinimi kontrol√º
                    if (data.trust_score < 0.7) {
                        document.getElementById('photoRequired').textContent = '(ZORUNLU)';
                        document.getElementById('reportPhoto').required = true;
                        document.getElementById('photoMsg').textContent = ' - Fotoƒüraf zorunludur.';
                    } else {
                        document.getElementById('photoRequired').textContent = '';
                        document.getElementById('reportPhoto').required = false;
                        document.getElementById('photoMsg').textContent = '';
                    }
                    
                    // Ba≈üarƒ± mesajƒ±
                    let statusMsg = '';
                    if (data.report_status === 'verified') {
                        statusMsg = '‚úÖ Doƒürulanmƒ±≈ü';
                    } else if (data.report_status === 'pending') {
                        statusMsg = '‚è≥ ƒ∞nceleniyor';
                    } else {
                        statusMsg = '‚ùå Reddedildi';
                    }
                    
                    alert(`üéâ Bildirim g√∂nderildi!\n\n` +
                          `üìä Durum: ${statusMsg}\n` +
                          `üéØ Doƒüruluk: %${data.accuracy}\n` +
                          `‚≠ê G√ºven Puanƒ±: ${data.trust_score} (${data.trust_change > 0 ? '+' : ''}${data.trust_change})\n` +
                          `üìù Toplam Bildirim: ${data.total_reports}`);
                    
                    // Formu temizle
                    document.querySelector('#tabReport form').reset();
                    document.getElementById('fillValue').textContent = '50%';
                    
                    // Dashboard'u g√ºncelle
                    loadDashboard();
                    loadLeaderboard();
                } else {
                    alert('‚ùå Hata: ' + data.error);
                }
            } catch (e) {
                alert('‚ùå Baƒülantƒ± hatasƒ±! ' + e.message);
            }
        }

        function showTab(tab) {
            ['report', 'map', 'containers', 'leaderboard'].forEach(t => {
                document.getElementById('tab' + t.charAt(0).toUpperCase() + t.slice(1)).classList.add('hidden');
            });
            document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.remove('hidden');
            
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            // Butona tƒ±klanarak √ßaƒürƒ±ldƒ±ysa event var, yoksa (selectContainer gibi) programatik √ßaƒürƒ±
            if (typeof event !== 'undefined' && event.target) {
                event.target.classList.add('active');
            } else {
                // Programatik √ßaƒürƒ±da aktif tab'ƒ± bul ve i≈üaretle
                const tabBtns = document.querySelectorAll('.tab-btn');
                const tabIndex = ['report', 'map', 'containers', 'leaderboard'].indexOf(tab);
                if (tabIndex >= 0 && tabBtns[tabIndex]) {
                    tabBtns[tabIndex].classList.add('active');
                }
            }
            
            if (tab === 'map') {
                setTimeout(() => {
                    if (map) {
                        map.invalidateSize();
                        // Harita ilk kez a√ßƒ±lƒ±yorsa marker'larƒ± y√ºkle
                        if (!markerCluster) {
                            loadMapMarkers();
                        }
                    }
                }, 100);
            }
            if (tab === 'containers') loadContainers();
        }

        function showError(id, msg, type = 'error') {
            const el = document.getElementById(id);
            el.textContent = msg;
            el.className = `alert alert-${type}`;
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 5000);
        }

        window.addEventListener('DOMContentLoaded', () => {
            const saved = localStorage.getItem('user');
            if (saved) {
                currentUser = JSON.parse(saved);
                showUserPanel();
            }
        });
    </script>
</body>
</html>
